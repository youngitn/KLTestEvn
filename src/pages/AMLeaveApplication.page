<!--> 
 請假申請流程VF
 因後續尚有眾多修改計畫以此流程為基準,
 所以沒有共用計畫.
<-->
<apex:page applyhtmltag="true" doctype="html-5.0" extensions="AMLeaveApplicationExtension" standardcontroller="Approval_Managed__c">
    <!-- 請假申請流程 -->
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <html>
        <head>
            <link href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet"/>
            <link crossorigin="anonymous" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" rel="stylesheet"/>
            <link href="https://unpkg.com/purecss@1.0.0/build/base-min.css" rel="stylesheet"/>
            <script crossorigin="anonymous" src="{!URLFOR($Resource.JSbundle, '/libs/jquery-3.2.1.js')}">
            </script>
            <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js">
            </script>
            <script type="text/javascript" src="https://malsup.github.io/jquery.blockUI.js"></script>
            <script>
                const  j$ = jQuery.noConflict();
                var openLookupPage = null;
             	j$( function() {
             		{!ActionOfStatus}
             		j$( "select[id*=Approval_Status]").bind("change",function(){
             			j$(this).val('D');
             		});
             		
             		addButtonClass();				
						
				  
				  ////////////////////////////////////////////////////////////////////////
				  ////////////////////////////////////////////////////////////////////////
				  ////////////////註冊 請假人員選擇的彈跳視窗事件  ///////////////////////
				  ///////////////點擊請假人input open選擇視窗/////////////////////////////
				  ////////////////////////////////////////////////////////////////////////
				  	j$("input[id $= Employee]").on('click',function() {
				  		if (openLookupPage != null){
				  			openLookupPage.close();
				  		}

					  	 openLookupPage = window.open('/_ui/common/data/LookupPage?lkfm=j_id0:j_id3:form&lknm=j_id0:j_id3:form:Employee&lktp=' + getElementByIdCS('j_id0:j_id3:form:Employee_lktp').value + '&lksrch=' + escapeUTF(getElementByIdCS('j_id0:j_id3:form:Employee').value.substring(0, 80)),"_blank","toolbar=yes,scrollbars=yes,resizable=yes,top=500,left=500,width=400,height=400");
					  });
				  	//當請假人input VALUE改變時 關閉人員選擇視窗	
					  j$("input[id $= Employee]").on('change',function(){
					  	
					  	openLookupPage.close();
					  	setTimeout(getEmpInfo, 500);
					  });
				 ////////////////////////////////////////////////////////////////////////
				 ////////////////////////////////////////////////////////////////////////
				 ////////////////////////////////////////////////////////////////////////
				 ////////////////////////////////////////////////////////////////////////
				 ////////////////////////////////////////////////////////////////////////
				  });
			//取得請假人資料 進入點
			function getEmpInfo() {
					  		
						  	let cId = j$("input[id $= Employee_lkid]").val();
						  	if (cId != '000000000000000' && cId != null && cId != ''){
						  		j$('form[id$=form]').block({ message: '從SAP讀取資料中...'});
						  		queryVacation(cId);
						  		queryEmpId(cId);
						  		
						  	}
					  		
					  	}
       		//從controller取請假人的聯絡資料
            function queryEmpId(cId){

            		AMLeaveApplicationExtension.queryEmpId(cId, function(result, event) {
                    if (event.status && result!=null) {

                       JSON.parse(result.replace(/(&quot\;)/g,"\""),function(k, v) {
                       	console.log(k+','+v); 
                       	if (k == 'Take_Office_Date') {
						 	j$('input[id $= Take_Office_Date]').val( v!= null?v.trim():v);
						 }

						 
						 if (k == 'Job_Title_Level') {
						 	j$('input[id $= Job_Title_Level]').val(v!= null?v.trim():v);
						 }

						 if (k == 'Applicant_position') {
						 	j$('input[id $= Applicant_position]').val(v!= null?v.trim():v);
						 }      
					

                       });
                       // let empId = result;
                       // j$('input[id $= Employee_Code]').val(empId);
                       j$('form[id$=form]').unblock();
                    }
                    
                })

            	
            }
            //將所有按鈕class風格統一 	
            function addButtonClass(){
            	j$( "input[type=submit]").removeClass('btn').addClass( "pure-button pure-button-primary pure-u-2-3" );
            }
            //從SAP取請假資料
            function queryVacation(cId) {
                //let empId = j$('input[id $= Name]').val();
               //alert(empId);
                AMLeaveApplicationExtension.queryVacation(cId, function(result, event) {
                    if (event.status && result!=null) {
                        
                        
                        JSON.parse(result.replace(/(&quot\;)/g,"\""),function(k, v) {
						  console.log(k+','+v); 
						 //調休可用時數
						 if (k == 'adjustable_vacation__c') {
						 	j$('input[id $= Adjustable_vacation]').val(v!= null?v.trim():v);
						 }

						 //特休可用時數
						 if (k == 'annual_leave__c') {
						 	j$('input[id $= Annual_leave]').val(v!= null?v.trim():v);
						 }

						 if (k == 'employee_code__c') {
						 	j$('input[id $= Employee_Code]').val(v!= null?v.trim():v);
						 }      
						});
                        
                        
                        
                    }
                });
            }
            </script>
        </head>
        <body>
            <apex:sectionheader title="請假申請流程">
            </apex:sectionheader>
            <apex:pageblock >
                <apex:form id="form" styleclass="pure-form pure-form-stacked" >
                    <fieldset>
                        <legend>
                            基本資料
                        </legend>
                        <div class="pure-g">
                            <div class="pure-u-1-3">
                                申請人姓名:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Applicant_Name__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                申請人工號:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Applicant_Code__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                流程名稱:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Approval_Name__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                單號:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Name}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                公司代碼:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Applicant_Corp_Code__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                申請人部門:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Dept_Name__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                申請日期:
                                <input class="pure-u-2-3" readonly="true" value="{!am.Bill_Date__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                審批狀態:
                                <apex:inputfield id="Approval_Status" styleclass="pure-u-2-3" value="{!am.Approval_Status__c}">
                                </apex:inputfield>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>
                            請假資訊
                        </legend>
                        <div class="pure-g">
                            <div class="pure-u-1-3 ">
                                <label for="Employee">
                                    請假人
                                </label>
                                <apex:inputfield id="Employee" required="true" styleclass="pure-u-2-3" value="{!am.Employee__c}">
                                </apex:inputfield>
                            </div>
                            <div class="pure-u-1-3 ">
                                <label for="Employee_Code">
                                    請假人工號
                                </label>
                                <apex:inputfield id="Employee_Code" styleclass="pure-u-2-3" value="{!am.Employee_Code__c}">
                                </apex:inputfield>
                            </div>
                            <div class="pure-u-1-3">
                                <label for="Annual_leave">
                                    特休可用時數
                                </label>
                                <apex:inputfield id="Annual_leave" styleclass="pure-u-2-3" value="{!am.Annual_leave__c}">
                                </apex:inputfield>
                            </div>
                            <div class="pure-u-1-3">
                                <label for="Adjustable_vacation">
                                    調休可用時數
                                </label>
                                <apex:inputfield id="Adjustable_vacation" styleclass="pure-u-2-3" value="{!am.Adjustable_vacation__c }">
                                </apex:inputfield>
                            </div>
                            <div class="pure-u-1-3">
                                <label for="Sum_Vacation">
                                    休假時數合計
                                </label>
                                <apex:inputfield id="Sum_Vacation" styleclass="pure-u-2-3" value="{!am.Sum_Vacation__c}">
                                </apex:inputfield>
                            </div>
                            <div class="pure-u-1-3">
                                <label for="Applicant_position">
                                    請假人職稱
                                </label>
                                <input class="pure-u-2-3" id="Applicant_position" type="text" value="{!am.Applicant_position__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                <label for="Job_Title_Level">
                                    請假人職等
                                </label>
                                <input class="pure-u-2-3" id="Job_Title_Level" value="{!am.Job_Title_Level__c}">
                                </input>
                            </div>
                            <div class="pure-u-1-3">
                                <label for="Take_Office_Date">
                                    到職日期
                                </label>
                                <input class="pure-u-2-3" id="Take_Office_Date" value="{!am.Take_Office_Date__c}">
                                </input>
                            </div>
                        </div>
                    </fieldset>
                    <br/>
                    <br/>
                    <div class="pure-g">
                        <div class="pure-u-1-3">
                        </div>
                        <div class="pure-u-1-12" >
                            <apex:commandbutton action="{!save}" id="btnSave" value="儲存">
                            </apex:commandbutton>
                        </div>
                        <div class="pure-u-1-12">
                            <apex:commandbutton action="{!cancel}" id="btnCancel" value="取消">
                            </apex:commandbutton>
                        </div> 
                    </div>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <div id="detail">
                        <!-- 页面信息提示区 -->
                        <apex:pagemessages escape="true" id="message">
                        </apex:pagemessages>
                        <div class="pure-u-1-12">
                            <apex:commandbutton action="{!newlist1}" immediate="true" rerender="list1" status="retrieveStatus" value="新增假別">
                            </apex:commandbutton>
                        </div>
                        <apex:outputpanel id="list1" layout="block" styleclass="scroll">
                            <apex:actionstatus id="retrieveStatus" starttext="(waiting...)">
                            </apex:actionstatus>
                            <table border="0" cellpadding="0" cellspacing="0" class="pure-table" id="tableBank" width="100%">
                                <thead>
                                    <th>
                                    </th>
                                    <th>
                                        序號
                                    </th>
                                    <th>
                                        假別
                                    </th>
                                    <th>
                                        請假事由
                                    </th>
                                    <th>
                                        請假開始日期
                                    </th>
                                    <th>
                                        請假開始時間
                                    </th>
                                    <th>
                                        請假結束日期
                                    </th>
                                    <th>
                                        請假結束時間
                                    </th>
                                    <th>
                                        請假時數(小時)
                                    </th>
                                </thead>
                                <tbody>
                                    <apex:variable value="{!0}" var="list1Index">
                                    </apex:variable>
                                    <apex:repeat value="{!list1}" var="item">
                                        <tr>
                                            <td>
                                                <script>
                                                    addButtonClass();
                                                </script>
                                                <apex:commandbutton action="{!deletelist1}" immediate="true" rerender="list1" value="删除">
                                                    <apex:param assignto="{!list1Row}" name="list1Row" value="{!list1Index}">
                                                    </apex:param>
                                                </apex:commandbutton>
                                            </td>
                                            <td>
                                                {!list1Index+1}
                                            </td>
                                            <!-- 假别 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" value="{!item.TypesOfLeave__c}">
                                                </apex:inputfield>
                                            </td>
                                            <!-- 请假事由 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" value="{!item.Leave_reason__c}">
                                                </apex:inputfield>
                                            </td>
                                            <!-- 请假开始日期 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" styleclass="datepicker" value="{!item.Start_date__c}">
                                                </apex:inputfield>
                                            </td>
                                            <!-- 请假开始时间 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" value="{!item.Start_Time__c}">
                                                </apex:inputfield>
                                            </td>
                                            <!-- 请假结束日期 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" styleclass="datepicker" value="{!item.End_date__c}">
                                                </apex:inputfield>
                                            </td>
                                            <!-- 请假结束时间 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" value="{!item.End_Time__c}">
                                                </apex:inputfield>
                                            </td>
                                            <!-- 请假时数 -->
                                            <td>
                                                <apex:inputfield required="true" style="width: 100%" value="{!item.time_number__c}">
                                                </apex:inputfield>
                                            </td>
                                        </tr>
                                        <apex:variable value="{!list1Index+1}" var="list1Index">
                                        </apex:variable>
                                    </apex:repeat>
                                </tbody>
                            </table>
                        </apex:outputpanel>
                    </div>
                </apex:form>
            </apex:pageblock>
        </body>
    </html>
</apex:page>